{% extends "base.html" %}

{% block title %}Dashboard - Homelab Inventory System{% endblock %}

{% block content %}
<div class="new-dashboard" x-data="dashboardState()" x-init="init()">

    <!-- Persistent Search Bar -->
    <div class="persistent-search" x-data="searchState()" @keydown.escape="searchFocused = false">
        <div class="search-bar-wrapper">
            <input
                type="text"
                class="search-input"
                placeholder="🔍 Search inventory..."
                x-model="query"
                @input.debounce.300ms="performSearch()"
                @focus="searchFocused = true"
                @keydown.escape="searchFocused = false"
                autocomplete="off"
            >
            <span class="search-result-count" x-show="results.length > 0" x-text="results.length + ' result' + (results.length !== 1 ? 's' : '')"></span>
        </div>

        <!-- Search Results Container (Always Present) -->
        <div class="search-results-container">
            <div class="search-results-content"
                 x-show="searchFocused && results.length > 0"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 @click.outside="searchFocused = false">

                <template x-for="item in results" :key="item.id">
                    <div class="search-result-item"
                         @mouseenter="onSearchResultHover(item)"
                         @mouseleave="onSearchResultLeave()"
                         @click="viewLocation(item.location_id); $event.stopPropagation();">

                        <div class="result-main">
                            <span class="result-name" x-text="item.name"></span>
                            <span class="badge" x-show="item.category" x-text="item.category"></span>
                        </div>

                        <div class="result-breadcrumb" x-text="item.location_breadcrumb"></div>
                    </div>
                </template>

                <div class="search-footer" x-show="results.length >= searchLimit">
                    Showing <span x-text="searchLimit"></span> results. Refine search for more specific results.
                </div>
            </div>
        </div>
    </div>

    <!-- Module Grid -->
    <div class="module-grid">
        <template x-for="module in modules" :key="module.id">
            <div class="module-cell"
                 :class="{ 'highlighted': highlightedModule === module.id }"
                 @mouseenter="onModuleHover(module.id)"
                 @mouseleave="onModuleLeave()">

                <!-- Module Name -->
                <h3 class="module-cell-title" x-text="module.name"></h3>

                <!-- Module Description (if exists) -->
                <p class="module-description" x-show="module.description" x-text="module.description"></p>

                <!-- Level Links -->
                <ul class="level-links">
                    <template x-for="level in module.levels" :key="level.id">
                        <li :class="{ 'highlighted': highlightedLevel === level.id }"
                            @mouseenter="onLevelHover(level.id)"
                            @mouseleave="onLevelLeave()">
                            <a href="#" @click.prevent="viewLevel(module.id, level.id)" x-text="levelLabel(level)"></a>
                            <span class="level-stats" x-text="levelStats(level)"></span>
                        </li>
                    </template>
                </ul>

                <!-- Module Statistics Footer -->
                <div class="module-stats-footer" x-text="moduleStats(module)"></div>
            </div>
        </template>

        <!-- Empty State -->
        <div class="empty-state-grid" x-show="modules.length === 0">
            <p>No modules yet. <a href="{{ url_for('modules.new_module') }}">Create your first module</a></p>
        </div>
    </div>

    <!-- Location Detail Panel -->
    <div class="location-detail-panel"
         x-data="locationDetailState()"
         x-show="visible"
         @show-location-detail.window="showDetail($event.detail.locationId)"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="transform translate-x-full"
         x-transition:enter-end="transform translate-x-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="transform translate-x-0"
         x-transition:leave-end="transform translate-x-full">

        <div class="detail-header">
            <h2>Location Details</h2>
            <button @click="visible = false" class="close-btn">&times;</button>
        </div>

        <div class="detail-breadcrumb" x-text="location.breadcrumb"></div>

        <div class="detail-body">
            <!-- Location Info -->
            <div class="detail-section">
                <h3>Location</h3>
                <div class="detail-group">
                    <label>Address</label>
                    <p x-text="location.full_address"></p>
                </div>
                <div class="detail-group" x-show="location.location_type">
                    <label>Type</label>
                    <p x-text="location.location_type"></p>
                </div>
                <div class="detail-group" x-show="location.dimensions">
                    <label>Dimensions</label>
                    <p x-text="formatDimensions(location.dimensions)"></p>
                </div>
                <div class="detail-group" x-show="location.notes">
                    <label>Notes</label>
                    <p x-text="location.notes"></p>
                </div>
            </div>

            <!-- Item Info (if occupied) -->
            <div class="detail-section" x-show="location.item">
                <h3>Item in this Location</h3>
                <div class="detail-group">
                    <label>Name</label>
                    <p x-text="location.item?.name"></p>
                </div>
                <div class="detail-group" x-show="location.item?.description">
                    <label>Description</label>
                    <p x-text="location.item?.description"></p>
                </div>
                <div class="detail-group" x-show="location.item?.category">
                    <label>Category</label>
                    <p><span class="badge" x-text="location.item?.category"></span></p>
                </div>
            </div>

            <!-- Empty Location Message -->
            <div class="detail-section" x-show="!location.is_occupied">
                <p class="empty-location-msg">This location is currently empty.</p>
            </div>

            <!-- Actions -->
            <div class="detail-actions">
                <a :href="'/items/' + location.item?.id" x-show="location.item" class="btn btn-primary">
                    View Full Item Details
                </a>
                <a :href="'/modules/' + location.module_id" class="btn btn-secondary">
                    View Module & Grid
                </a>
            </div>
        </div>
    </div>

    <!-- Footer Statistics Bar -->
    <div class="dashboard-footer-stats">
        <span class="stat-item">
            <strong x-text="stats.modules"></strong> modules
        </span>
        <span class="stat-separator">•</span>
        <span class="stat-item">
            <strong x-text="stats.levels"></strong> levels
        </span>
        <span class="stat-separator">•</span>
        <span class="stat-item">
            <strong x-text="stats.locations"></strong> locations
        </span>
        <span class="stat-separator">•</span>
        <span class="stat-item">
            Overall: <strong x-text="stats.occupancy_pct + '%'"></strong>
            (<span x-text="stats.occupied + '/' + stats.total"></span>)
        </span>
    </div>

</div>


<script>
// Dashboard State Management
function dashboardState() {
    return {
        modules: [],
        stats: {
            modules: 0,
            levels: 0,
            locations: 0,
            total: 0,
            occupied: 0,
            occupancy_pct: 0
        },
        highlightedModule: null,
        highlightedLevel: null,
        searchHoverActive: false,

        async init() {
            await this.loadModules();
            this.setupEventListeners();
        },

        async loadModules() {
            try {
                const response = await fetch('/api/dashboard/stats');
                const data = await response.json();
                this.modules = data.modules;
                this.stats = {
                    modules: data.overall.modules,
                    levels: data.overall.levels,
                    locations: data.overall.locations,
                    total: data.overall.locations,
                    occupied: data.overall.occupied,
                    occupancy_pct: data.overall.occupancy_pct
                };
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        },

        setupEventListeners() {
            window.addEventListener('highlight-location', (event) => {
                this.searchHoverActive = true;
                this.highlightedModule = event.detail.moduleId;
                this.highlightedLevel = event.detail.levelId;
            });

            window.addEventListener('clear-highlight', () => {
                this.searchHoverActive = false;
                this.highlightedModule = null;
                this.highlightedLevel = null;
            });
        },

        levelLabel(level) {
            return level.name || `Level ${level.level_number}`;
        },

        levelStats(level) {
            return `${level.occupied}/${level.total}`;
        },

        moduleStats(module) {
            return `${module.occupied}/${module.total} (${module.occupancy_pct}%)`;
        },

        onModuleHover(moduleId) {
            if (!this.searchHoverActive) {
                this.highlightedModule = moduleId;
            }
        },

        onModuleLeave() {
            if (!this.searchHoverActive) {
                this.highlightedModule = null;
            }
        },

        onLevelHover(levelId) {
            if (!this.searchHoverActive) {
                this.highlightedLevel = levelId;
            }
        },

        onLevelLeave() {
            if (!this.searchHoverActive) {
                this.highlightedLevel = null;
            }
        },

        viewLevel(moduleId, levelId) {
            // Navigate to the module view page with the level
            window.location.href = `/modules/${moduleId}#level-${levelId}`;
        }
    };
}

// Search State Management
function searchState() {
    return {
        query: '',
        results: [],
        searchLimit: 3,
        searchFocused: false,

        async performSearch() {
            if (this.query.length < 2) {
                this.results = [];
                return;
            }

            try {
                const response = await fetch(`/search/api/live?q=${encodeURIComponent(this.query)}&limit=${this.searchLimit}`);
                const data = await response.json();
                this.results = data.results;
            } catch (error) {
                console.error('Error performing search:', error);
                this.results = [];
            }
        },

        onSearchResultHover(item) {
            window.dispatchEvent(new CustomEvent('highlight-location', {
                detail: {
                    moduleId: item.module_id,
                    levelId: item.level_id
                }
            }));
        },

        onSearchResultLeave() {
            window.dispatchEvent(new CustomEvent('clear-highlight'));
        },

        viewLocation(locationId) {
            if (!locationId) {
                alert('This item does not have a location assigned.');
                return;
            }
            // Close search dropdown
            this.searchFocused = false;
            // Clear highlights
            window.dispatchEvent(new CustomEvent('clear-highlight'));
            // Show location detail
            window.dispatchEvent(new CustomEvent('show-location-detail', {
                detail: { locationId }
            }));
        }
    };
}

// Location Detail State Management
function locationDetailState() {
    return {
        visible: false,
        location: {
            breadcrumb: '',
            full_address: '',
            location_type: '',
            dimensions: null,
            notes: '',
            is_occupied: false,
            item: null,
            module_id: null
        },

        async showDetail(locationId) {
            try {
                const response = await fetch(`/locations/api/locations/${locationId}/detail`);
                const data = await response.json();
                this.location = data;
                this.visible = true;
            } catch (error) {
                console.error('Error loading location details:', error);
                alert('Error loading location details');
            }
        },

        formatDimensions(dims) {
            if (!dims) return '';
            return `${dims.width_mm} × ${dims.height_mm} × ${dims.depth_mm} mm`;
        }
    };
}
</script>
{% endblock %}
