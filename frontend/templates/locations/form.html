{% extends "base.html" %}

{% block title %}{% if location %}Edit Location - {{ location.full_address() }}{% else %}New Location{% endif %} - WhereTF?{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{% if location %}Edit Location: {{ location.full_address() }}{% else %}Create New Location{% endif %}</h1>
</div>

<form method="POST" class="form">
    {% if not location %}
    <div class="form-group">
        <label for="module_id">Module *</label>
        <select id="module_id" name="module_id" required>
            <option value="">Select a module...</option>
            {% for module in modules %}
            <option value="{{ module.id }}">{{ module.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="level_id">Level *</label>
        <select id="level_id" name="level_id" required disabled>
            <option value="">Select a module first...</option>
        </select>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="row">Row *</label>
            <input type="text" id="row" name="row" required placeholder="A, B, C...">
            <small>Single letter or number</small>
        </div>

        <div class="form-group">
            <label for="column">Column *</label>
            <input type="text" id="column" name="column" required placeholder="1, 2, 3...">
            <small>Number identifier</small>
        </div>
    </div>
    {% endif %}

    <div class="form-group">
        <label for="location_type">Location Type</label>
        <input type="text" id="location_type" name="location_type" value="{{ location.location_type if location else 'general' }}" list="location_types">
        <datalist id="location_types">
            <option value="general">
            <option value="small_box">
            <option value="medium_bin">
            <option value="large_bin">
            <option value="liquid_container">
            <option value="smd_container">
            <option value="bulk_storage">
        </datalist>
        <small>Type of storage location</small>
    </div>

    <h3>Dimensions (optional)</h3>
    <div class="form-row">
        <div class="form-group">
            <label for="width_mm">Width (mm)</label>
            <input type="number" id="width_mm" name="width_mm" value="{{ location.width_mm or '' }}" step="0.1" min="0">
        </div>

        <div class="form-group">
            <label for="height_mm">Height (mm)</label>
            <input type="number" id="height_mm" name="height_mm" value="{{ location.height_mm or '' }}" step="0.1" min="0">
        </div>

        <div class="form-group">
            <label for="depth_mm">Depth (mm)</label>
            <input type="number" id="depth_mm" name="depth_mm" value="{{ location.depth_mm or '' }}" step="0.1" min="0">
        </div>
    </div>

    <div class="form-group">
        <label for="notes">Notes</label>
        <textarea id="notes" name="notes" rows="3">{{ location.notes or '' }}</textarea>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">{% if location %}Update Location{% else %}Create Location{% endif %}</button>
        <a href="{% if location %}{{ url_for('locations.view_location', location_id=location.id) }}{% else %}{{ url_for('locations.list_locations') }}{% endif %}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

{% if not location %}
<script>
// Dynamic level loading based on selected module
document.getElementById('module_id').addEventListener('change', async function() {
    const moduleId = this.value;
    const levelSelect = document.getElementById('level_id');

    if (!moduleId) {
        levelSelect.innerHTML = '<option value="">Select a module first...</option>';
        levelSelect.disabled = true;
        return;
    }

    try {
        const response = await fetch(`/modules/api/modules/${moduleId}/levels`);
        const levels = await response.json();

        levelSelect.innerHTML = '<option value="">Select a level...</option>';
        levels.forEach(level => {
            const option = document.createElement('option');
            option.value = level.id;
            option.textContent = `Level ${level.level_number}${level.name ? ' - ' + level.name : ''}`;
            levelSelect.appendChild(option);
        });
        levelSelect.disabled = false;
    } catch (error) {
        console.error('Error loading levels:', error);
        levelSelect.innerHTML = '<option value="">Error loading levels</option>';
    }
});
</script>
{% endif %}

{% endblock %}
