{% extends "base.html" %}

{% block title %}{% if item %}Edit{% else %}New{% endif %} Item - Homelab Inventory{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{% if item %}Edit Item{% else %}New Item{% endif %}</h1>
</div>

<form method="POST" class="form">
    <div class="form-group">
        <label for="name">Name *</label>
        <input type="text" id="name" name="name" value="{{ item.name if item else '' }}" required>
    </div>

    <div class="form-group">
        <label for="description">Description *</label>
        <textarea id="description" name="description" rows="4" required>{{ item.description if item else '' }}</textarea>
        <small>Natural language description of the item</small>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="category">Category</label>
            <input type="text" id="category" name="category" value="{{ item.category if item else '' }}" list="categories">
            <datalist id="categories">
                <option value="Electronics">
                <option value="Fasteners">
                <option value="Tools">
                <option value="Paints & Coatings">
                <option value="Hardware">
                <option value="Materials">
            </datalist>
        </div>

        <div class="form-group">
            <label for="item_type">Item Type</label>
            <input type="text" id="item_type" name="item_type" value="{{ item.item_type if item else '' }}" list="item_types">
            <datalist id="item_types">
                <option value="solid">
                <option value="liquid">
                <option value="smd_component">
                <option value="bulk">
                <option value="tool">
            </datalist>
        </div>
    </div>

    <div class="form-group">
        <label for="tags">Tags</label>
        <input type="text" id="tags" name="tags" value="{{ item.tags if item else '' }}" placeholder="metric, stainless, m6, bolt">
        <small>Comma-separated tags</small>
    </div>

    <div class="form-group">
        <label for="notes">Notes</label>
        <textarea id="notes" name="notes" rows="3">{{ item.notes if item else '' }}</textarea>
    </div>

    <h3>{% if item %}Add to New Location{% else %}Initial Location{% endif %}</h3>
    <div class="form-group">
        <label for="location_select">{% if item %}Select Location to Add{% else %}Location{% endif %}</label>
        <button type="button" class="btn btn-secondary" id="suggest-btn" style="margin-bottom: 0.5rem;">
            üéØ Suggest Smart Locations
        </button>
        <div id="suggestions-container" style="display: none; margin-bottom: 1rem; padding: 1rem; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 0.5rem;">
            <h4 style="margin-top: 0;">Suggested Locations</h4>
            <div id="suggestions-list"></div>
        </div>
        <select id="location_select" name="location_id">
            <option value="">{% if item %}Choose a location to add...{% else %}Select later...{% endif %}</option>
            {% for module in modules %}
                <optgroup label="{{ module.name }}">
                {% for level in module.levels %}
                    {% for location in level.locations %}
                        <option value="{{ location.id }}">{{ location.full_address() }}</option>
                    {% endfor %}
                {% endfor %}
                </optgroup>
            {% endfor %}
        </select>
        {% if item %}
        <small class="text-muted">Select a location above and click the button below to add this item there.</small>
        <button type="button" class="btn btn-primary" id="add-location-btn" style="margin-top: 0.5rem; display: none;">
            ‚ûï Add Item to Selected Location
        </button>
        {% endif %}
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">{% if item %}Update{% else %}Create{% endif %} Item</button>
        <a href="{% if item %}{{ url_for('items.view_item', item_id=item.id) }}{% else %}{{ url_for('items.list_items') }}{% endif %}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

{% if item %}
<div class="danger-zone">
    <h3>Danger Zone</h3>
    <form method="POST" action="{{ url_for('items.delete_item', item_id=item.id) }}" onsubmit="return confirm('Are you sure you want to delete this item?');">
        <button type="submit" class="btn btn-danger">Delete Item</button>
    </form>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const suggestBtn = document.getElementById('suggest-btn');
    const suggestionsContainer = document.getElementById('suggestions-container');
    const suggestionsList = document.getElementById('suggestions-list');
    const locationSelect = document.getElementById('location_select');
    const addLocationBtn = document.getElementById('add-location-btn');
    
    // Show/hide the "Add Location" button when selection changes (for edit form)
    if (locationSelect && addLocationBtn) {
        locationSelect.addEventListener('change', function() {
            if (this.value) {
                addLocationBtn.style.display = 'block';
            } else {
                addLocationBtn.style.display = 'none';
            }
        });
        
        // Handle add location button click
        addLocationBtn.addEventListener('click', function() {
            const locationId = locationSelect.value;
            if (!locationId) {
                alert('Please select a location first.');
                return;
            }
            
            const itemId = window.location.pathname.split('/')[2]; // Get item ID from URL
            const locationAddress = locationSelect.options[locationSelect.selectedIndex].text;
            
            if (confirm(`Add this item to ${locationAddress}?`)) {
                window.location.href = `/items/${itemId}/locations/add?location_id=${locationId}`;
            }
        });
    }
    
    if (suggestBtn) {
        suggestBtn.addEventListener('click', async function() {
            // Get current form values
            const category = document.getElementById('category').value;
            const itemType = document.getElementById('item_type').value;
            const tags = document.getElementById('tags').value;
            
            if (!category && !itemType && !tags) {
                alert('Please fill in at least one of: Category, Item Type, or Tags to get suggestions.');
                return;
            }
            
            // Show loading state
            suggestBtn.disabled = true;
            suggestBtn.textContent = '‚è≥ Getting suggestions...';
            suggestionsList.innerHTML = '<p>Loading...</p>';
            suggestionsContainer.style.display = 'block';
            
            try {
                // Call the API
                const response = await fetch('/items/api/suggest-location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        category: category,
                        item_type: itemType,
                        tags: tags,
                        limit: 5
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to get suggestions');
                }
                
                const suggestions = await response.json();
                
                // Display suggestions
                if (suggestions.length === 0) {
                    suggestionsList.innerHTML = '<p class="text-muted">No suitable locations found. Try adding more details to your item.</p>';
                } else {
                    let html = '<div class="suggestions-grid">';
                    suggestions.forEach((suggestion, index) => {
                        const loc = suggestion.location;
                        const rank = index + 1;
                        const score = suggestion.score;
                        const reasons = suggestion.reasons.join('<br>‚Ä¢ ');
                        
                        html += `
                            <div class="suggestion-card" data-location-id="${loc.id}">
                                <div class="suggestion-header">
                                    <span class="suggestion-rank">#${rank}</span>
                                    <strong class="suggestion-address">${loc.full_address}</strong>
                                    <span class="suggestion-score" title="Confidence score">${score}</span>
                                </div>
                                <div class="suggestion-reasons">
                                    ‚Ä¢ ${reasons}
                                </div>
                                <button type="button" class="btn btn-sm btn-primary select-location-btn" data-location-id="${loc.id}" data-location-address="${loc.full_address}">
                                    Select This Location
                                </button>
                            </div>
                        `;
                    });
                    html += '</div>';
                    suggestionsList.innerHTML = html;
                    
                    // Add click handlers to select buttons
                    document.querySelectorAll('.select-location-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const locationId = this.getAttribute('data-location-id');
                            const locationAddress = this.getAttribute('data-location-address');
                            
                            // Set the select dropdown
                            locationSelect.value = locationId;
                            
                            // Show the add location button if we're on edit form
                            if (addLocationBtn) {
                                addLocationBtn.style.display = 'block';
                            }
                            
                            // Scroll to the select dropdown
                            locationSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        });
                    });
                }
            } catch (error) {
                console.error('Error fetching suggestions:', error);
                suggestionsList.innerHTML = '<p style="color: var(--danger-color);">Error loading suggestions. Please try again.</p>';
            } finally {
                // Reset button
                suggestBtn.disabled = false;
                suggestBtn.textContent = 'üéØ Suggest Smart Locations';
            }
        });
    }
});
</script>

<style>
.suggestions-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.suggestion-card {
    padding: 1rem;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 0.375rem;
    transition: box-shadow 0.2s;
}

.suggestion-card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.suggestion-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.suggestion-rank {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    font-weight: bold;
    font-size: 0.875rem;
}

.suggestion-address {
    flex: 1;
    font-size: 1.1rem;
    color: var(--primary-color);
}

.suggestion-score {
    padding: 0.25rem 0.5rem;
    background: var(--bg-color);
    border-radius: 0.25rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.suggestion-reasons {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.75rem;
    line-height: 1.6;
}

.select-location-btn {
    width: 100%;
}
</style>
{% endblock %}
